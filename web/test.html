<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>IRCSET — E2E API Tester (with Registration)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b1020;--card:#111936;--muted:#93a0b5;--text:#e9eef7;--accent:#6ea8fe;--ok:#1dd1a1;--bad:#ff6b6b}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid #223}
  h1{margin:0;font-size:20px}
  main{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px}
  .panel{background:var(--card);border-radius:12px;padding:14px;border:1px solid #223}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 4px}
  input,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a355a;background:#0d1430;color:var(--text)}
  input:focus{border-color:var(--accent);outline:none}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{cursor:pointer;background:#17214a;border-color:#2a355a}
  button.primary{background:linear-gradient(180deg,#2d5bff,#1840d4);border:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #223;vertical-align:top}
  th{font-size:12px;color:#c6d2eb;text-align:left}
  .ok{color:var(--ok);font-weight:600}
  .bad{color:var(--bad);font-weight:600}
  pre{white-space:pre-wrap;background:#0a0f26;border:1px solid #1b254a;border-radius:10px;padding:10px;max-height:45vh;overflow:auto}
  .muted{color:var(--muted);font-size:12px}
  @media (max-width: 980px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>IRCSET — End-to-End API Tester</h1>
  <div class="muted">Start with <code>python3 -m http.server 8000</code>. API default: <code>http://localhost:3005</code>.</div>
</header>
<main>
  <div class="panel">
    <label>API Base URL</label>
    <input id="base" value="http://localhost:3005" />

    <label>Submission Title</label>
    <input id="title" value="Auto Test Submission" />

    <label>Reviewer Score (0–10)</label>
    <input id="rating" value="8" />

    <label>Upload a PDF</label>
    <input id="pdf" type="file" accept="application/pdf" />

    <div class="row" style="margin-top:12px">
      <button class="primary" onclick="runAll()" id="runBtn">Run Full Flow</button>
      <button onclick="makeSample()">Make Sample PDF</button>
    </div>

    <div style="margin-top:10px" class="muted">
      Accounts auto-created during flow:<br/>
      <code>admin1@example.com</code>, <code>author@email.com</code>, <code>chair1@example.com</code>, <code>reviewer1@example.com</code><br/>
      Password: <code>StrongP@ssw0rd!</code>
    </div>
  </div>

  <div class="panel">
    <table id="results">
      <thead>
        <tr><th style="width:220px">Step</th><th>Status</th><th>Details</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="section-title" style="margin-top:12px;font-size:12px;color:#c6d2eb">Raw Log</div>
    <pre id="log"></pre>
  </div>

  <div class="panel">
    <label>Download Final as…</label>
    <input id="dlSubId" placeholder="Submission ID (defaults to last run)" />
    <div class="row" style="margin-top:8px">
      <button onclick="dlAs('author', this)">Author</button>
      <button onclick="dlAs('chair', this)">Chair</button>
      <button onclick="dlAs('reviewer', this)">Reviewer</button>
      <button onclick="dlAs('admin', this)">Admin</button>
    </div>
  </div>
</main>

<script>
/* ===== config ===== */
const CREDS = {
  admin:    { email:'admin1@example.com',    password:'StrongP@ssw0rd!', name:'Admin One' },
  author:   { email:'author@email.com',   password:'StrongP@ssw0rd!', name:'Author One' },
  chair:    { email:'chair1@example.com',    password:'StrongP@ssw0rd!', name:'Chair One' },
  reviewer: { email:'reviewer1@example.com', password:'StrongP@ssw0rd!', name:'Reviewer One' }
};
let CSRF = '';
let LAST_EVENT_ID = null;
let LAST_SUB_ID = null;
let USER_IDS = {};

/* ===== helpers ===== */
function base(){ return document.getElementById('base').value.replace(/\/+$/,''); }
function score(){ return Number(document.getElementById('rating').value || 5); }
function logLine(...args){ const pre=document.getElementById('log'); pre.textContent+=args.join(' ')+"\n"; pre.scrollTop=pre.scrollHeight; }
function setRow(step,ok,msg){ const tbody=document.querySelector('#results tbody'); const tr=document.createElement('tr'); tr.innerHTML=`<td>${step}</td><td>${ok?'<span class="ok">PASS</span>':'<span class="bad">FAIL</span>'}</td><td><pre>${escapeHtml(typeof msg==='string'?msg:JSON.stringify(msg,null,2))}</pre></td>`; tbody.appendChild(tr); return ok; }
function clearUI(){ document.querySelector('#results tbody').innerHTML=''; document.getElementById('log').textContent=''; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ===== HTTP ===== */
async function http(path,{method='GET',body=null,isForm=false}={}){ const opts={method,credentials:'include',headers:{}}; if(isForm){opts.body=body;} else if(body){opts.headers['Content-Type']='application/json'; opts.body=JSON.stringify(body);} if(method!=='GET'&&CSRF){opts.headers['X-CSRF-Token']=CSRF;} const res=await fetch(base()+path,opts); const data=await res.json().catch(()=>null); logLine(method,path,'→',res.status,JSON.stringify(data)); return{ok:res.ok,status:res.status,data}; }
async function getCsrf(){ const r=await http('/auth/csrf-token'); if(r.ok) CSRF=r.data?.csrfToken||r.data?.token||CSRF; return r.ok; }
async function login(email, password){
  for (let attempt=0; attempt<3; attempt++){
    const r = await http('/auth/login', { method:'POST', body:{ email, password }});
    if (r.ok){
      // refresh CSRF after login
      await getCsrf();
      return true;
    }
    if (r.status !== 429) return false;
    await sleep(1200 * (attempt+1));
  }
  return false;
}
async function logout(){ await http('/auth/logout',{method:'POST'}); }

/* ===== registration helper ===== */
async function ensureRegistered(user){
  let r=await http('/auth/register',{method:'POST',body:{email:user.email,password:user.password,name:user.name}});
  if(r.ok){ setRow(`Register ${user.email}`,true,r.data); return r.data.user?.id; }
  if(r.status===409){ setRow(`Register ${user.email}`,true,'Already exists'); 
    const all=await http('/admin/users'); 
    const found=(all.data?.items||[]).find(u=>u.email===user.email);
    return found?.id;
  }
  setRow(`Register ${user.email}`,false,r.data||r.status);
  return null;
}

/* ===== main flow ===== */
async function runAll(){
  clearUI();
  const btn=document.getElementById('runBtn'); btn.disabled=true; btn.textContent='Running...';
  try{
    await getCsrf();

    // 0) Register all accounts
    for(const role of Object.keys(CREDS)){
      if(role==='admin'){ // admin created via bootstrap seed, skip register
        USER_IDS[role]=1; 
      } else {
        await login(CREDS.admin.email,CREDS.admin.password); // need admin to call /admin/users fallback
        const id=await ensureRegistered(CREDS[role]);
        USER_IDS[role]=id;
        await logout();
      }
    }

    // 1) Admin — create event
    await login(CREDS.admin.email,CREDS.admin.password);
    let r=await http('/admin/events',{method:'POST',body:{name:'Auto Event '+Date.now(),description:'Test event'}});
    if(!r.ok) return setRow('Create event',false,r.data);
    LAST_EVENT_ID=r.data.event?.id;
    setRow('Create event',true,r.data);

    // Assign roles
    r=await http(`/admin/events/${LAST_EVENT_ID}/assign`,{method:'POST',body:{user_id:USER_IDS.chair,role:'chair'}}); setRow('Assign chair',r.ok,r.data);
    r=await http(`/admin/events/${LAST_EVENT_ID}/assign`,{method:'POST',body:{user_id:USER_IDS.reviewer,role:'reviewer'}}); setRow('Assign reviewer',r.ok,r.data);
    r=await http(`/admin/events/${LAST_EVENT_ID}/assign`,{method:'POST',body:{user_id:USER_IDS.author,role:'author'}}); setRow('Assign author',r.ok,r.data);
    await logout();

    // 2) Author — submit paper
    await login(CREDS.author.email, CREDS.author.password);
    const fd = new FormData();
    fd.append('pdf', document.getElementById('pdf').files[0]);
    fd.append('title', document.getElementById('title').value);

    r = await http(`/submissions/${LAST_EVENT_ID}`, {
      method: 'POST',
      isForm: true,
      body: fd
    });
    LAST_SUB_ID = r.data.submission?.id;
    setRow('Submit paper', r.ok, r.data);
    await logout();


// 3) Chair — assign reviewer
await login(CREDS.chair.email, CREDS.chair.password);
r = await http(`/events/${LAST_EVENT_ID}/submissions/${LAST_SUB_ID}/assign`, {
  method:'POST',
  body:{ reviewer_id: USER_IDS.reviewer }
});
setRow('Assign reviewer', r.ok, r.data);
await logout();

// 4) Reviewer — submit review
await login(CREDS.reviewer.email, CREDS.reviewer.password);
r = await http(`/events/${LAST_EVENT_ID}/submissions/${LAST_SUB_ID}/reviews`, {
  method:'POST',
  body:{ score: score(), comments_for_author: 'auto ok' }
});
setRow('Submit review', r.ok, r.data);
await logout();

// 5) Chair — make decision
await login(CREDS.chair.email, CREDS.chair.password);
r = await http(`/events/${LAST_EVENT_ID}/submissions/${LAST_SUB_ID}/decision`, {
  method:'POST',
  body:{ decision: 'accept', reason: 'auto accept' }
});
setRow('Make decision', r.ok, r.data);
await logout();

// 6) Author — upload final
await login(CREDS.author.email, CREDS.author.password);
const fd2 = new FormData();
fd2.append('pdf', document.getElementById('pdf').files[0]);

r = await http(`/submissions/${LAST_EVENT_ID}/${LAST_SUB_ID}/final`, {
  method: 'POST',
  isForm: true,
  body: fd2
});
setRow('Upload final', r.ok, r.data);
await logout();


  }catch(e){ setRow('Unexpected',false,e.message||e); }
  finally{ btn.disabled=false; btn.textContent='Run Full Flow'; }
}

/* ===== sample PDF ===== */
function makeSample(){ const blob=new Blob(["%PDF-1.4\n1 0 obj<<>>endobj\ntrailer<<>>%%EOF\n"],{type:'application/pdf'}); const f=new File([blob],"sample.pdf",{type:'application/pdf'}); const input=document.getElementById('pdf'); const dt=new DataTransfer(); dt.items.add(f); input.files=dt.files; }

/* ===== download final ===== */
async function dlAs(who,btn){ /* same as before, can be filled in */ }
</script>
</body>
</html>
