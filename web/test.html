<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>IRCSET — One-Click E2E (Stop-on-fail)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b1020;--card:#111936;--muted:#93a0b5;--text:#e9eef7;--accent:#6ea8fe;--ok:#1dd1a1;--bad:#ff6b6b}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid #223}
  h1{margin:0;font-size:20px}
  main{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px}
  .panel{background:var(--card);border-radius:12px;padding:14px;border:1px solid #223}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 4px}
  input,button,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a355a;background:#0d1430;color:var(--text)}
  input:focus,select:focus{border-color:var(--accent);outline:none}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{cursor:pointer;background:#17214a;border-color:#2a355a}
  button.primary{background:linear-gradient(180deg,#2d5bff,#1840d4);border:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #223;vertical-align:top}
  th{font-size:12px;color:#c6d2eb;text-align:left}
  .ok{color:var(--ok);font-weight:600}
  .bad{color:var(--bad);font-weight:600}
  pre{white-space:pre-wrap;background:#0a0f26;border:1px solid #1b254a;border-radius:10px;padding:10px;max-height:45vh;overflow:auto}
  .muted{color:var(--muted);font-size:12px}
  @media (max-width: 980px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>IRCSET — One-Click End-to-End (Stop on fail)</h1>
  <div class="muted">Serve via <code>python3 -m http.server 8000</code>. Ensure API CORS allows this origin. API base defaults to <code>http://localhost:3005</code>.</div>
</header>
<main>
  <div class="panel">
    <label>API Base URL</label>
    <input id="base" value="http://localhost:3005" />

    <label>Submission Title</label>
    <input id="title" value="Auto Test Submission" />

    <div class="row">
      <div style="flex:1">
        <label>Category (must exist)</label>
        <input id="category" value="A" />
      </div>
      <div style="flex:1">
        <label>Reviewer score (1..5 or controller-specific)</label>
        <input id="rating" value="5" />
      </div>
    </div>

    <label>Upload a PDF (used for submission &amp; final)</label>
    <input id="pdf" type="file" accept="application/pdf" />

    <div class="row" style="margin-top:12px">
      <button class="primary" onclick="runAll()" id="runBtn">Run Full Flow</button>
      <button onclick="makeSample()">Make Sample PDF</button>
    </div>

    <div style="margin-top:10px" class="muted">
      Pre-seeded accounts (pwd <code>StrongP@ssw0rd!</code>): author1 / admin1 / chair1 / reviewer1 / dm1 @example.com.
      Reviewer &amp; decision-maker scoped to category “A”.
    </div>
  </div>

  <div class="panel">
    <table id="results">
      <thead>
        <tr><th style="width:220px">Step</th><th>Status</th><th>Details</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="section-title" style="margin-top:12px;font-size:12px;color:#c6d2eb">Raw Log</div>
    <pre id="log"></pre>
  </div>

    <div class="panel">
    <label>Download Final as…</label>
    <input id="dlSubId" placeholder="Submission ID (defaults to last run)" />

    <div class="row" style="margin-top:8px">
<button data-role="author"  onclick="dlAs('author', this)">Author</button>
<button data-role="chair"   onclick="dlAs('chair', this)">Chair</button>
<button data-role="reviewer"onclick="dlAs('reviewer', this)">Reviewer</button>
<button data-role="dm"      onclick="dlAs('dm', this)">Decision Maker</button>
<button data-role="admin"   onclick="dlAs('admin', this)">Admin</button>
    </div>

    <div class="muted" style="margin-top:8px">
        Uses <code>/submissions/:id/final.pdf?dl=1</code> with credentials.  
        If you don’t enter an ID, it uses the last submission created by this page.
    </div>
  </div>
</main>

<script>
/* ===== config / helpers ===== */
const CREDS = {
  author:   { email:'author@email.com',   password:'StrongP@ssw0rd!' },
  admin:    { email:'admin1@example.com',    password:'StrongP@ssw0rd!' },
  chair:    { email:'chair1@example.com',    password:'StrongP@ssw0rd!' },
  reviewer: { email:'reviewer1@example.com', password:'StrongP@ssw0rd!' },
  dm:       { email:'dm1@example.com',       password:'StrongP@ssw0rd!' },
};
let CSRF = '';
function base(){ return document.getElementById('base').value.replace(/\/+$/,''); }
function cat(){ return document.getElementById('category').value.trim() || 'A'; }
function score(){ return Number(document.getElementById('rating').value || 5); }
function logLine(...args){
  const pre = document.getElementById('log');
  pre.textContent += args.map(a=>typeof a==='string'?a:JSON.stringify(a,null,2)).join(' ')+"\n";
  pre.scrollTop = pre.scrollHeight;
}
function setRow(step, ok, msg){
  const tbody = document.querySelector('#results tbody');
  const tr = document.createElement('tr');
  const s = document.createElement('td'); s.textContent = step;
  const st = document.createElement('td'); st.innerHTML = ok?'<span class="ok">PASS</span>':'<span class="bad">FAIL</span>';
  const d = document.createElement('td'); d.innerHTML = (typeof msg==='string')?msg:('<pre>'+escapeHtml(JSON.stringify(msg,null,2))+'</pre>');
  tr.appendChild(s); tr.appendChild(st); tr.appendChild(d); tbody.appendChild(tr);
  return ok;
}
function clearUI(){ document.querySelector('#results tbody').innerHTML=''; document.getElementById('log').textContent=''; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/* ===== HTTP ===== */
async function http(path, { method='GET', body=null, isForm=false } = {}){
  const opts = { method, credentials:'include', headers:{} };
  if(isForm){ opts.body = body; }
  else if (body && typeof body === 'object'){ opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
  if(method !== 'GET' && method !== 'HEAD' && method !== 'OPTIONS' && CSRF){ opts.headers['X-CSRF-Token'] = CSRF; }
  const url = base()+path;
  const res = await fetch(url, opts);
  const ct = res.headers.get('content-type')||'';
  let data = null;
  if (ct.includes('application/json')) data = await res.json().catch(()=>null);
  else data = await res.text().catch(()=>null);
  logLine(method, path, '→', res.status, data);
  return { ok: res.ok, status: res.status, data, res };
}
async function getCsrf(){
  const r = await http('/auth/csrf-token');
  if (r.ok){ CSRF = r.data?.token || r.data?.csrfToken || r.data?.csrf || CSRF; }
  return r.ok;
}
async function login(email, password){
  // avoid 429s
  for (let attempt=0; attempt<3; attempt++){
    const r = await http('/auth/login', { method:'POST', body:{ email, password }});
    if (r.ok){ await getCsrf(); return true; }
    if (r.status !== 429) return false;
    await sleep(1200 * (attempt+1));
  }
  return false;
}
async function logout(){ await http('/auth/logout', { method:'POST' }); }

/* ===== small helpers ===== */
function getIdFrom(data){
  if (!data) return null;
  if (typeof data === 'object'){
    if (Number.isInteger(data.id)) return data.id;
    if (data.submission?.id) return data.submission.id;
    if (data.data){
      if (Number.isInteger(data.data.id)) return data.data.id;
      if (Array.isArray(data.data) && data.data[0]?.id) return data.data[0].id;
    }
    if (Array.isArray(data) && data[0]?.id) return data[0].id;
  }
  return null;
}
function stop(step, ok, details){ setRow(step, ok, details); throw new Error('STOP'); }

/* ===== main (stop on first failure) ===== */
async function runAll(){
  clearUI();
  const btn = document.getElementById('runBtn'); btn.disabled = true; btn.textContent = 'Running...';
  try{
    // 0) basic checks
    let r = await http('/');             if (!setRow('API root', r.ok, r.data||r.status)) return;
    r = await http('/healthz');          if (!setRow('/healthz', r.ok, r.data)) return;
    r = await http('/readyz');           if (!setRow('/readyz', r.ok, r.data)) return;

    await getCsrf();                     if (!setRow('Get CSRF', !!CSRF, CSRF?'CSRF token set':'Missing CSRF')) return;

    // 1) AUTHOR — login
    let ok = await login(CREDS.author.email, CREDS.author.password);
    if (!ok) return stop('Author login', false, 'Login failed');
    setRow('Author login', true, 'Logged in as author1');

    // 1.1) Create submission
    const file = document.getElementById('pdf').files[0];
    if (!file) return stop('Create submission', false, 'Attach a PDF first');

    const fd = new FormData();
    fd.append('pdf', file, file.name);
    fd.append('title', document.getElementById('title').value || 'Auto Test Submission');
    fd.append('abstract', 'Auto test abstract');
    fd.append('category', cat());
    fd.append('category_id', cat());
    
    r = await http('/submissions', { method:'POST', isForm:true, body: fd });
    if (!r.ok) return stop('Create submission', false, r.data||r.status);
    setRow('Create submission', true, r.data||r.status);

    let subId = getIdFrom(r.data);
    if (!subId){
      const mine = await http('/submissions/mine');
      if (!mine.ok) return stop('Submission ID', false, 'Cannot list mine');
      const arr = Array.isArray(mine.data)?mine.data:(mine.data?.data||[]);
      subId = arr.map(x=>x.id).filter(Number.isInteger).sort((a,b)=>b-a)[0];
    }
    if (!subId) return stop('Submission ID', false, 'ID not found');
    setRow('Submission ID', true, 'ID = '+subId);
    LAST_SUB_ID = subId;
    await logout(); await sleep(300);

    // 2) CHAIR — assign reviewer1 (category required)
    ok = await login(CREDS.chair.email, CREDS.chair.password);
    if (!ok) return stop('Chair login', false, 'Login failed');
    setRow('Chair login', true, 'Logged in as chair1');

    r = await http(`/chair/reviewers?category=${encodeURIComponent(cat())}`);
    if (!r.ok) return stop('List reviewers', false, r.data||r.status);

    let reviewerId = null;
    const list = Array.isArray(r.data)?r.data:(r.data?.items||r.data?.data||[]);
    if (Array.isArray(list) && list.length){
      const found = list.find(u => (u.email||'').toLowerCase() === CREDS.reviewer.email);
      reviewerId = found?.id || list[0]?.id || null;
    }
    if (!reviewerId) return stop('Find reviewer id', false, 'No reviewers returned');
    setRow('Find reviewer id', true, 'Reviewer ID = '+reviewerId);

    r = await http(`/chair/submissions/${encodeURIComponent(subId)}/assign?category=${encodeURIComponent(cat())}`, {
      method:'POST', body:{ reviewers:[reviewerId] }
    });
    if (!r.ok) return stop('Assign reviewer', false, r.data||r.status);
    setRow('Assign reviewer', true, r.data||r.status);
    await logout(); await sleep(300);

    // 3) REVIEWER — submit review (controller may require "score" not "rating")
    ok = await login(CREDS.reviewer.email, CREDS.reviewer.password);
    if (!ok) return stop('Reviewer login', false, 'Login failed');
    setRow('Reviewer login', true, 'Logged in as reviewer1');

    let body = {
        score_overall: score(),                   // 0..10
        comments_for_author: 'Auto test review',  // optional
        comments_confidential: ''                 // optional
    };
    r = await http(`/reviewer/submissions/${encodeURIComponent(subId)}/reviews`, { method:'POST', body });
    if (!r.ok && (String(r.data?.error||'').toLowerCase().includes('score') || String(r.data?.error||'').toLowerCase().includes('bad'))){
      // retry once with a safe middle value (some backends expect 1..10)
      await sleep(300);
      body = { rating: 4, score: 4, comment:'Auto test review' };
      r = await http(`/reviewer/submissions/${encodeURIComponent(subId)}/reviews`, { method:'POST', body });
    }
    if (!r.ok) return stop('Submit review', false, r.data||r.status);
    setRow('Submit review', true, r.data||r.status);
    await logout(); await sleep(300);

    // 4) DECISION — accept (requires >= minReviews)
    ok = await login(CREDS.dm.email, CREDS.dm.password);
    if (!ok) return stop('Decision-maker login', false, 'Login failed');
    setRow('Decision-maker login', true, 'Logged in as dm1');

    r = await http(`/decisions/queue?category=${encodeURIComponent(cat())}`);
    if (!r.ok) return stop('Decisions queue', false, r.data||r.status);
    setRow('Decisions queue', true, r.data||r.status);

    r = await http(`/decisions/${encodeURIComponent(subId)}`);
    if (!r.ok) return stop('Decision detail', false, r.data||r.status);
    const nReviews = Number(r.data?.n_reviews ?? 0);
    const minReviews = Number((await http(`/decisions/queue?category=${encodeURIComponent(cat())}`)).data?.minReviews ?? 1);
    if (nReviews < minReviews) return stop('Decision precheck', false, `Not enough reviews (${nReviews}/${minReviews})`);

    r = await http(`/decisions/${encodeURIComponent(subId)}?category=${encodeURIComponent(cat())}`, {
    method:'POST',
    body:{ decision:'accept', reason:'Auto accept', category: cat() }
    });
    if (!r.ok) return stop('Make decision (accept)', false, r.data||r.status);
    setRow('Make decision (accept)', true, r.data||r.status);
    await logout(); await sleep(300);

    // 5) AUTHOR — upload final + download
    ok = await login(CREDS.author.email, CREDS.author.password);
    if (!ok) return stop('Author re-login', false, 'Login failed');
    setRow('Author re-login', true, 'Logged back in');

    const fd2 = new FormData();
    fd2.append('pdf', file, file.name);

    // pass optional IRC membership email for finals gate
    const ircEmail = (document.getElementById('ircEmail')?.value || '').trim();
    if (ircEmail) {
    // primary key used by server code you showed
    fd2.append('irc_member_email_optional', ircEmail);
    // (belt-and-braces) some builds used this name:
    fd2.append('irc_member_email', ircEmail);
    }

    r = await http(`/submissions/${encodeURIComponent(subId)}/final`, {
    method:'POST', isForm:true, body: fd2
    });
    if (!r.ok) return stop('Upload final', false, r.data||r.status);
    setRow('Upload final', true, r.data||r.status);

    // await sleep(200); // tiny settle time for fs/db
    // const dlUrl = base()+`/submissions/${encodeURIComponent(subId)}/final.pdf?dl=1`;
    // const dl = await fetch(dlUrl, { credentials:'include' });    if (!dl.ok) return stop('Download final (GET)', false, 'HTTP '+dl.status);
    // setRow('Download final (GET)', true, 'HTTP '+dl.status);
    await logout();

    // 6) ADMIN — smoke (optional, if you want to keep going comment out the stop-on-fail behavior above)
    ok = await login(CREDS.admin.email, CREDS.admin.password);
    if (!ok) return stop('Admin login', false, 'Login failed');
    setRow('Admin login', true, 'Logged in as admin1');
    r = await http('/admin/users');       if (!r.ok) return stop('GET /admin/users', false, r.data||r.status);
    setRow('GET /admin/users', true, r.data||r.status);
    r = await http('/admin/categories');  if (!r.ok) return stop('GET /admin/categories', false, r.data||r.status);
    setRow('GET /admin/categories', true, r.data||r.status);
    await logout();

  } catch(e){
    if (e && e.message === 'STOP'){ /* already logged */ }
    else { setRow('Unexpected error', false, String(e?.message || e)); logLine('Unexpected error:', e); }
  } finally {
    document.getElementById('runBtn').disabled = false; document.getElementById('runBtn').textContent = 'Run Full Flow';
  }
}

/* ===== utilities ===== */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function makeSample(){
  const blob = new Blob(["%PDF-1.4\n1 0 obj<<>>endobj\ntrailer<<>>%%EOF\n"], { type:'application/pdf' });
  const f = new File([blob], "sample.pdf", { type:'application/pdf' });
  const input = document.getElementById('pdf');
  try { const dt = new DataTransfer(); dt.items.add(f); input.files = dt.files; }
  catch { const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='sample.pdf'; a.click(); URL.revokeObjectURL(url); }
}

async function safeLogout() {
  try { await getCsrf(); } catch {}
  try {
    const r = await http('/auth/logout', { method: 'POST' });
    // treat 200/401/403 as "done" so we don't spam logs
    return r.ok || r.status === 401 || r.status === 403;
  } catch {
    return true;
  }
}

let LAST_SUB_ID = null; // updated after createSubmission step
const DL_BUSY = { author:false, chair:false, reviewer:false, dm:false, admin:false };

function roleLabel(k){
  return {author:'Author', chair:'Chair', reviewer:'Reviewer', dm:'Decision Maker', admin:'Admin'}[k] || k;
}

async function dlAs(who, btn=null){
  if (DL_BUSY[who]) return;            // prevent concurrent clicks
  DL_BUSY[who] = true;
  if (btn) btn.disabled = true;

  const input = (document.getElementById('dlSubId')?.value || '').trim();
  const sid = input ? Number(input) : LAST_SUB_ID;
  if (!sid || !Number.isInteger(sid)) {
    setRow(`Download as ${roleLabel(who)}`, false, 'Provide a Submission ID or run the flow first.');
    if (btn) btn.disabled = false; DL_BUSY[who] = false;
    return;
  }

  const cred = CREDS[who];
  if (!cred) {
    setRow(`Download as ${roleLabel(who)}`, false, `Unknown role: ${who}`);
    if (btn) btn.disabled = false; DL_BUSY[who] = false;
    return;
  }

  try {
    // login
    const okLogin = await login(cred.email, cred.password);
    if (!okLogin) { setRow(`Login (${roleLabel(who)})`, false, 'Login failed'); return; }

    // small settle time then fetch with ?dl=1
    await sleep(200);
    const url = base()+`/submissions/${encodeURIComponent(sid)}/final.pdf?dl=1`;
    const res = await fetch(url, { credentials: 'include' });

    if (!res.ok) {
      setRow(`Download as ${roleLabel(who)}`, false, `HTTP ${res.status}`);
      return;
    }

    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `final_${sid}_${who}.pdf`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
    setRow(`Download as ${roleLabel(who)}`, true, `Saved as final_${sid}_${who}.pdf`);
  } catch (e) {
    setRow(`Download as ${roleLabel(who)}`, false, String(e?.message || e));
  } finally {
    await safeLogout();                // single, idempotent logout
    if (btn) btn.disabled = false;
    DL_BUSY[who] = false;
  }
}
</script>
</body>
</html>
